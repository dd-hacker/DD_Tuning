# DD_Tuning

> **DD_Hackはこのプロジェクトに含まれるものを使用したことによる損害に一切責任を負いません。**<br>

B社のDD車をいじるプロジェクトです。<br>
主に小さい踏力でより強くアシストを効かせることに重点を置いており、<br>
主に16~20km/hで真価を発揮するプロジェクトです。24km/h以上でアシストするものではありませんし、<br>
モーターの最大トルクが増大するものでもありません。モーターの"余裕"を使ってより楽に走行しようというものです。<br>
この改造を適用すると道交法上の電動アシスト自転車の基準に合致しないおそれがあります。
オフモードも実装していますが、保証はできません。

> 現在ドキュメント類が完成していません。なんとなく察せる方やこの手の作業に詳しい方の作業をおすすめします。

## サポートについて

本プロジェクトは個人開発のものです。海外の大規模なチューニングチップ開発会社などとは異なります。<br>
`issue`で新機能の開発、制御の変更、不具合の修正などを依頼することが出来るので、ぜひご利用ください。<br>
質問も`issue`で受け付けます。基本的にプロジェクトに関することであればどんなこともお答えしようと思いますが、内容によっては回答できない可能性もあります。<br>
`issue`は様々なことに積極的に使っていただければと思います。システムのレビューも歓迎です。<br>

動作は開発者の手元にある`TB7B41(TB70-T)`のみでチェックしています。<br>
(そのため`TB7B41`等で使用することに特にフォーカスした機能が多めです)<br>
より街乗りを意識した車種でのレビューもお待ちしています。<br>

> このプロジェクトはApple製デバイス(iPhone,Mac等)の使用はおすすめしません。<br>
> (動作するという確証が取れていないため)

## 必要なもの

-   対象の車両(おそらく2020年モデル以降のDD車)
-   Windows 10以上のPC
-   Arduino IDEが使用できる環境
-   Android 9以降を搭載していて、Bluetooth Low Energyをサポートする端末
-   nRF ConnectとWebブラウザ(もしくは後日公開予定のAndroidアプリとWebブラウザ)
-   SoCが`ESP32-C3`のマイコン(推奨)
    -   Flashが4MB以上のものを推奨します。
    -   `ESP32-C3`以外のSoCでもできるだけ動作するようにしていますが、<br>
        Hシリーズ、Pシリーズ、S2など、Wi-FiとBluetooth(BLE)が搭載されていないSoCでは使用できません。
-   はんだごて、はんだ(フラックスなど周辺アイテムもあるとさらに良いです)
-   配線(可能であれば、青、緑、赤、黒の配線をそれぞれ用意すると良いです)

<br>

---

<br>

以下は配線を損傷したくない場合、取り外し可能にしたい場合は必要です<br>

-   ヒロセ電機 DF62Wシリーズ 6線タイプ一式
    -   `DF62W-6S-2.2C` `DF62W-6EP-2.2C`それぞれ×1、<br>
        `DF62W-2226SCF` `DF62W-2226PCF` それぞれ×5、<br>
        `DF62W-WP` ×2
-   JST JWPFシリーズ 8線タイプ一式
    -   `08T-JWPF-VSLE-D` `08R-JWPF-VSLE-D`それぞれ×1、
        `SWPT-001T-P025` `SWPR-001T-P025`それぞれ×5

<br>

> JWPFはAliExpressなどで互換品が手に入りますが、<br>
> DF62Wは手に入れるのが少し難しい可能性があります。<br>
> (また、これらには予備は含まれません。正直難易度が高いので予備を用意することをおすすめします)

## 取り付け

> 配線を損傷しても良い人は、一部スキップできます。<br>
> 車両の配線をカットして、直接はんだ付けするのが一番早いです。(元に戻せなくなるという問題はありますが)<br>
> GPIO配置を変更した場合はその構成に合わせてください。<br>

<br>

### クランク回転センサーから信号を受け取る

まず、自転車側のクランク回転センサーの信号が来る位置(緑線、青線)に合わせ、<br>
`DF62W-6EP-2.2C`に配線と`DF62W-2226PCF`をカシメたものを挿入して信号が受け取れるようにします。<br>
その後反対側の被覆を剥き、`GPIO 0`に緑、`GPIO 1`に青をはんだ付けします。<br>
都合が悪い場合は、他の場所に配線してください。その後設定の変更が必要です。<br>

### コントローラに信号を出力する

コントローラ側の緑線、青線の位置に合わせ、<br>
`DF62W-6S-2.2C`に配線と`DF62W-2226SCF`をカシメたものを挿入し、信号が送信できるようにします。<br>
その後反対側の被覆を剥き、`GPIO 2`に緑、`GPIO 3`に青を配線してください。<br>
都合が悪い場合は、他の場所に配線してください。その後設定の変更が必要です。<br>

### 残りの線を接続する

残りの信号はそのまま利用します。配線を直結するように作成してください。

### 電源を取る

5Vを取るには、コントローラからパネルへ向かう配線の茶色が+、紫が-とすると5Vが取れます。<br>
(電流量が少ないので別途USBポートなどを搭載していると影響を及ぼす可能性があります)<br>
JWPFのセットを使用して、延長ケーブルのようなものを作りますが、作る際に対象の2本の中間の被覆をあらかじめ剥いておきます。<br>
そこに電源を取る際にはんだ付けすることで電源を取れます。(その後ビニールテープなどを巻いておいてください)<br>
その配線をマイコン基板の5Vと記載されているピンに茶(赤線が望ましい)を、<br>
GNDと記載されているピンに紫(黒が望ましい)をはんだ付けしてください。<br>
3V3ピンに接続してしまうとマイコンが破損します。よく確認を行ってください。
(ホールセンサー用配線から3Vを取る方法もありますが、そちらは試していません)

### 防水処理をする

当然マイコンに水がかかると動作不良、故障の原因になります。<br>
ビニールテープをしっかりと巻くなど、マイコンに水が付着しないようにしてください。

## セットアップ

(Arduino IDEのインストールは省略しています)

<br>

### Arduino IDEへのボードマネージャ等のインストール

ボードマネージャの検索画面で`ESP32`と検索し、`esp32 by Espressif Systems`をインストール。

現在ボードマネージャのバージョンは3.3.0まで対応の確認ができています。

<br>

### ライブラリ類

追加は不要だったかと思いますが、もし動作しなければご連絡ください。

<br>

### オプションの設定

-   **`KEY_ID`**<br>
    ロックを解除するためのキーとして使うUUIDです。<br>
    これをnRF Connectなどでアドバタイズすることでロックを解除できます。
-   **`PIN_CODE`**<br>
    オフモードを解除するためのPINです。変更することを推奨します。
-   **`MFG_NUMBER`**<br>
    近くにDD_Tuningシステムを搭載した車両が複数あるときなどに識別しやすくするための番号です。<br>
    そのままでも利用できますが、設定することを推奨します。(0から255までの値が利用できます)<br>
-   **`LOCK_MODE`**<br>
    ロック機能を使用するかどうかの設定です。無効にするとシステムの機能が露呈しやすくなり、盗難リスクも高まります。
-   **`AESキー`**<br>
    他人にOTAアップデートを行われないために使用します。変更しなくても使用はできますが、念の為変更することを推奨します。<br>
    添付のツール(`aes.py`)から出てくるターミナル出力を使用することで変更できます。<br>
    これを変更しても物理的にアクセスを行われてスケッチを変更されてしまう可能性はあります。<br>
    また、このキーを紛失するとアップデートが利用できなり、一度PCで書き込む必要があります。<br>


## 書き込み設定

書き込む際の設定です。<br>
まず`BOOT`ボタンを押しながらPCに接続し、`ESP32 Family Dev Module`を選択、<br>
ボードを`ESP32C3 Dev Module`(もしくはお持ちのマイコンのもの)に設定します。<br>
そしてツールから、`USB CDC On Boot`を`Enabled`に。<br>
(デバッグをしたいときに使います)<br>
`Partition Scheme`を`Minimal SPIFFS`に。<br>
(Flashが4MBのモデルではない場合は他の適切なものを選択してください)<br>
APP領域は現在のバージョンで最低1.3MBが必要です。<br>
OTAアップデートを使用するには、`NoOTA`と書かれていないものを使用し、<br>
1.3MB×2以上のAPP領域を確保してください。<br>
(将来のアップデートで必要容量が変化する可能性があります)<br>
一部のFlashが2MBのモデルでは容量不足のためOTAアップデートは使用できません。<br>
他の部分は変更しなくても動作しますが、<br>
デュアルコアのSoCを使用する場合はArduino RunとEvent Runのコアを分けることをおすすめします。<br>
(そうすると処理の安定性が若干向上するはずです)

## 書き込んだ後

(※まだAndroidアプリは完成していません。`nRF Connect`を使用してください)
<br>

まず`nRF Connect`を起動してみてください。チュートリアルを終えるとマイコンを起動してから20秒間、<br>
`DD_Tuning (ファームウェアバージョン)_(セットした番号)`という名前が表示されるはずです。<br>
`CONNECT`を押して接続してください。5つのキャラクタリスティックがあるか確認してください。<br>
上からプリセット切り替え、オフモード切り替え、アップデートモード切り替え、ロック状態表示、診断情報です。<br>
数字をキャラクタリスティックに"UTF-8テキストとして"送信することでモード切り替えができます。

### プリセット切り替え

0: Normal<br>
1: Cruise<br>
2: Fun<br>
3: Auto (ベータ版)<br>
4: Eco-Charging (使用できません)<br>
5: Turbo<br>


となっています。気に入ったものをご利用ください。初期設定では`Normal`になっています。<br>
(フィーリングがめちゃくちゃ大きく変わる、ということはあまりないかと思います)
<br>

#### Normal

ごく普通の制御のモード。大半の人はこれでいいかと思います。<br>
どの車両でも不満のないフィーリングのプリセットで、原点であるプリセットです。

#### Cruise

特に低ケイデンス・高めギアで走行したい人はこのモードにすると再加速・巡航がより快適になると思います。<br>
全てのDD車におすすめです。

#### Fun

レスポンスが良くなり、Ex-Boostと呼んでいる機能が使用できます。(後述)<br>
"楽な乗り物"というよりは"走り"を楽しくするプリセットで、スポーティーな車種に特におすすめです。

#### Auto

自動でアシスト力を調整します。ただし、現在も開発中のため不安定です。<br>
基本的に楽はしたいが巡航状態のときちょっと節電したいという状況にフィットする調整を目指しています。

#### Eco-Charging

平地充電機能を活用して充電しながら走行できるモードになる予定です。現在は実装していません。<br>
エネループバイクを意識したものにできればと思っていますが本質的な機能ではないので放置されています...

#### Turbo

研究している限りではこれが一番アシストパワー、レスポンスが高いセッティングです。Ex-Boostもより長く作動します。<br>
スポーティーな車種に限らず、とにかく楽をしたい方におすすめです。

### オフモード切り替え
オフモードとは一時的にドングルとしてのアシスト増加動作を無効化する設定です。<br>
あまり重点的に開発していませんがおそらく装着していないときと同じ動作になるはずです。<br>
キャラクタリスティックに`1`を送信すると有効になります。無効にするときは、`0`:設定したPINで解除できます。

### アップデートモード
OTAアップデートを開始するためのキャラクタリスティックです。<br>
これにより、追加機能をすぐにデバイスに搭載することが可能になります。<br>
キャラクタリスティックにテキストとして`1`を送信すると有効になります。無効にしたいときは、自転車を再起動してください。<br>
※この機能は、ロックを解除しなければ使用できません

### ロック状態表示
キャラクタリスティックの数値を読み込んだ時、`1`の場合は施錠状態、`0`の場合は解錠状態です。

### 診断情報表示
対応するプログラムを公開していませんが、この情報により動作状態などを確認することが出来ます。<br>
(将来的にこれをサポートするAndroidアプリを提供する可能性があります)

## ロックシステム

このシステムにはBluetooth Low Energyデバイスを利用したロックシステムが搭載されています。<br>
`nRF Connect`などを使用し、自転車の電源が入っているときに設定したUUIDをアドバタイズするとロック解除されます。<br>
デフォルトでは使用する設定になっていますが、使用しないことも出来ます。

## 走り方・楽しみ方

### 発進するときに考えること

設定、装着が適切に行われているのを前提に、<br>
電源を入れた後、ロックが解除されていればペダルを踏み込むだけで発進できます。<br>
うまくアシストしていない(SL表示が出るなど)ようでしたら、<br>
ロックが解除されているか、配線が適切かを再度確認してみてください。<br>

### 走行中に考えること

発進してからアシストに違和感があるときは一度ペダルを止めて、再度漕ぎ始めてみてください。大半のトラブルはそれで修正できます。<br>
基本的には中高速域(16-22km/h)のアシストパワーが大幅に向上しており、<br>
新たな加速感をお楽しみいただけると思います。20km/h付近での巡航も非常に容易になります。<br>
また、ある程度の坂などで強くペダルを踏んでいけば<br>
モーターが最大トルクの範囲内で強いパワーを発生し、爽快に坂を駆け上がることができます。<br>
ですがアシストパワーが増えたということは電力消費が多くなったということです。<br>
長距離を走行する場合はくれぐれもバッテリーの残量にはご注意ください。<br>
B400バッテリーでもこのシステムを搭載した車両にとって容量は多くありません。ご利用は計画的に。<br>
また、モーターの最大トルクにも注意してください。20%クラスの急坂など、<br>
そもそもモーターがフルパワーで駆動していても苦しい状況を改善するものではありません。<br>
そして、ペダルを本当に軽く回すだけでもモーターが駆動します。<br>
フリーからラチェット音がするくらいゆっくりとペダリングしても、平地であれば走行可能です。<br>
これを利用した走行をしていると私有地でも誰かが見ていれば不審に思われると思うので、やめたほうが良いでしょう。<br>
(チェーンが外れてしまった場合など、非常事態での利用に留めていただければと思います)
<br>

なんらかの危険を感じたり、ソフトウェアのバグが疑われる動作をしたと感じたら、オフモードを利用してみてください。<br>
純正に限りなく近い動作に戻るはずです。

### Ex-Boostを活用する

Ex-Boostと呼んでいる機能は、ペダルを止めてもモーターが一定のパワーで駆動し続ける機能で、<br>
主にライディングダイナミクスをさらに向上させるために開発した機能になっています。<br>
(スポーツ車でこれを使用してスラロームすると非常に楽しいです)<br>
ペダルを止めてからFunプリセットでは1.5秒、Turboプリセットでは5秒間作動します。<br>
それ以外のプリセットでは無効になっています。<br>
主に15km/h以下などで走行安定性、悪路走破性に寄与します。<br>
狭い場所で少しだけ加速したいとき、段差を超えるためにサドルから腰を浮かせるときなどにも役立ちます。<br>
しっかりと作動させるには、ペダルを蹴るように力を入れながら動かして止めると、<br>
15km/h以下ではそれなりに強いトルクを発生するはずです。<br>
ゆっくりとペダルを正転方向に動かし続けると動作が途切れづらくなり、安定します。<br>
この機能は左ブレーキレバーを握れば回生すると同時にキャンセルできます。<br>
ブレーキレバーを握った後再度Ex-Boostを作動させるには、ペダルを正転側に動かす必要がある場合があります。<br>
Ex-Boostは積極的に利用する機能というよりは特定のシーンで「こっそり、でも大胆に」<br>
運転者を支援するものだと考えていただければと思います。

### 乗り終わった時

基本的に電源をすぐに切っていただいて問題ありません。<br>
また、ロックを有効にしている場合は電源を切ると自動で再ロックされます。<br>
自転車を離れるときはどんなに短時間でも電源を切り、施錠することをおすすめします。<br>
ロック機能と物理錠で乗り逃げをさらに防げます。<br>